# mico

å°çˆ±æ‹¦æˆªå™¨ å¼€å‘ç‰ˆ

## å…·ä½“è§å¸–å­
https://bbs.hassbian.com/thread-5110-1-1.html

## ä¸€é”®å®‰è£…
```shell
curl -s "https://raw.githubusercontent.com/FlashSoft/mico/dev/install.sh?`date +%s`" > /root/install.sh
sh /root/install.sh
```

## NodeRedæˆªå›¾

![nodered](./nodered.png)

## NodeRedæµï¼ˆç›´æ¥å¯¼å…¥ï¼‰

```json
[{"id":"50a9f5e.b33610c","type":"tab","label":"å¤„ç†å°çˆ±è½¬å‘V3","disabled":false,"info":""},{"id":"c99debc2.933f78","type":"debug","z":"50a9f5e.b33610c","name":"HAè®¾å¤‡åˆ—è¡¨","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":610,"y":235,"wires":[]},{"id":"d4deea9.e378d18","type":"api-render-template","z":"50a9f5e.b33610c","name":"ğŸ”§éå†è®¾å¤‡","server":"4ccda836.aef688","template":"{% for state in states %}\n{{ state.domain }}||||{{ state.entity_id }}||||{{ state.attributes.friendly_name }}\n  \n{%- endfor %}","x":305,"y":235,"wires":[["64fbe9c2.c74258"]]},{"id":"64fbe9c2.c74258","type":"function","z":"50a9f5e.b33610c","name":"å¤„ç†","func":"const device_list = msg.payload.split('\\n').map(it => {\n  const [domain, entity_id, friendly_name] = it.split('||||')\n  return { domain, entity_id, friendly_name }\n})\nconst list = device_list.map(it => `${it.domain}\\t${it.friendly_name}`).join('\\n')\nflow.set('device_list', device_list)\nnode.status({fill:'green', text: (new Date()).toLocaleTimeString()})\nreturn {device_list, list}","outputs":1,"noerr":0,"x":460,"y":235,"wires":[["c99debc2.933f78"]]},{"id":"8d91e59c.7298c8","type":"inject","z":"50a9f5e.b33610c","name":"æ¯10åˆ†é’Ÿ","topic":"","payload":"","payloadType":"date","repeat":"600","crontab":"","once":true,"onceDelay":"1","x":135,"y":235,"wires":[["d4deea9.e378d18"]]},{"id":"9878305e.8d142","type":"api-call-service","z":"50a9f5e.b33610c","name":"æ“ä½œè®¾å¤‡","server":"4ccda836.aef688","service_domain":"","service":"","data":"","mergecontext":"","x":805,"y":445,"wires":[["e70679a2.f179a8"]]},{"id":"c6c5af4f.30365","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/get/asr","method":"get","upload":false,"swaggerDoc":"","x":125,"y":90,"wires":[["cf1f3130.17c31"]]},{"id":"dc997254.12ac","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":455,"y":90,"wires":[]},{"id":"cf1f3130.17c31","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§æ‹¦æˆªè¯","func":"// å¤šä¸ªè¯ä»¥ç«–çº¿åˆ†å‰²\nmsg.payload = `æ—©å®‰|æ™šå®‰`\nreturn msg","outputs":1,"noerr":0,"x":295,"y":90,"wires":[["dc997254.12ac"]]},{"id":"f92acc00.a5ec8","type":"comment","z":"50a9f5e.b33610c","name":"å°çˆ±asræ‹¦æˆªè¯","info":"è¿™é‡Œä¸»è¦æ˜¯é…ç½®ä½ å¯¹å°çˆ±è¯´çš„è¯çš„éƒ¨åˆ†\n\næ­£å¸¸æƒ…å†µä½ è·Ÿå°çˆ±è¯´\"æ—©å®‰\"æ˜¯ä¸ä¼šè½¬å‘ç»™NodeRedçš„\n\næ‰€ä»¥ä¸ºäº†èƒ½è¯´\"æ—©å®‰\"çš„æ—¶å€™èµ°ä½ çš„è‡ªå®šä¹‰çš„æµç¨‹,éœ€è¦é…ç½®ä¸‹ä½ å…ˆæ‹¦æˆªçš„è¯è¯­åˆ—è¡¨\n","x":115,"y":45,"wires":[]},{"id":"a5fa462f.898838","type":"comment","z":"50a9f5e.b33610c","name":"ç¼“å­˜HAè®¾å¤‡åˆ—è¡¨","info":"è¿™ä¸ªæµé‡Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿå®šæ—¶éå†HAçš„è®¾å¤‡åˆ—è¡¨\n\nä¸ºäº†ç»™HAè®¾å¤‡è‡ªåŠ¨æ“ä½œçš„æµåšå‡†å¤‡å·¥ä½œ\n\né»˜è®¤æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡\n\nåœ¨ä¿å­˜æµå1ç§’ä¹Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡\n\nå¹³æ—¶æ— éœ€æ‰‹åŠ¨æ‰§è¡Œæ­¤æµ\n\nè°ƒè¯•åŠæ³•:\n\nå¯ä»¥æ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ‰§è¡ŒæŒ‰é’®,ç„¶åçœ‹è°ƒè¯•çª—å£,æ‰¾åˆ°HAè®¾å¤‡åˆ—è¡¨è°ƒè¯•é¡¹,å±•å¼€listæ¡ç›®,å¯çœ‹åˆ°å½“å‰HAçš„è®¾å¤‡åˆ—è¡¨","x":120,"y":190,"wires":[]},{"id":"5c8c8822.c4aae8","type":"comment","z":"50a9f5e.b33610c","name":"HAè®¾å¤‡è‡ªåŠ¨åˆ¤å®šå¤„ç†é€»è¾‘","info":"æ­¤æµè§£å†³é€šè¿‡æ“ä½œè¯è¿›è¡Œæ§åˆ¶HAè®¾å¤‡åˆ—è¡¨é‡Œçš„è®¾å¤‡\n\nå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œç¼“å­˜HAåˆ—è¡¨æµå»çœ‹è°ƒè¯•ä¿¡æ¯é‡Œçš„è®¾å¤‡åˆ—è¡¨,ç„¶åè¯•å›¾å»å¼€å…³ä»–,æ”¯æŒåŒæ—¶æœ€å¤§æ§åˆ¶4ä¸ªè®¾å¤‡\n\nå¦‚æœè®¾å¤‡åˆ—è¡¨æ˜¯:\n\n```\nbinary_sensor\tå¤§é—¨çŠ¶æ€\nbinary_sensor\tæ¥¼æ¢¯äººä½“æ„Ÿåº”\nbinary_sensor\tæ¥¼ä¸Šå¼€å…³\nbinary_sensor\tå¤§é—¨é—¨é“ƒ\nfan\tæ¥¼ä¸Šå‡€åŒ–å™¨\nfan\tæ¥¼ä¸‹å‡€åŒ–å™¨\ngroup\tAirxç©ºæ°”å‡€åŒ–å™¨\ngroup\tall fans\ngroup\tall lights\ngroup\tall switches\ngroup\tall vacuum cleaners\ngroup\tåŒ—äº¬\ngroup\tå®¢å…ç©ºæ°”æ£€æµ‹ä»ª\ngroup\tå°ç±³\ninput_select\täº®åº¦\nlight\tå°å¤œç¯\nsensor\tä¸»å§æ¹¿åº¦\nsensor\tå…‰ç…§åº¦\nsensor\tç”²é†›\nsensor\tæ¹¿åº¦\nsensor\té¢—ç²’ç‰©\nsensor\tæ¸©åº¦\nsensor\tä¸»å§æ¸©åº¦\nsensor\tå½©äº‘å¤©æ°”\nswitch\tä¸»å§åŠ æ¹¿å™¨\nswitch\tå°çˆ±å¼€å…³\nswitch\tä¹¦æˆ¿æ’åº§\nswitch\tæ¥¼ä¸‹FFU\nswitch\tåŠŸç‡æ’åº§\nswitch\tæ¥¼ä¸ŠFFU\nswitch\tUSBæ’åº§\nvacuum\tæ¥¼ä¸Šæ‰«åœ°æœºå™¨äºº\n```\n\n\næˆ‘ä»¬å¯ä»¥è¿™æ ·å»æ§åˆ¶è®¾å¤‡:\n\n```\næ‰“å¼€æ¥¼ä¸Šæ‰«åœ°æœºå™¨äºº\næ‰“å¼€å°å¤œç¯å’Œä¸»å§åŠ æ¹¿å™¨\nå…³é—­ä¹¦æˆ¿æ’åº§\n```\n","x":150,"y":379,"wires":[]},{"id":"f73c7442.0df7c8","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/ha","method":"post","upload":false,"swaggerDoc":"","x":110,"y":439,"wires":[["47f8345a.030bcc"]]},{"id":"5f2f6570.b2435c","type":"function","z":"50a9f5e.b33610c","name":"TTSæ–‡æœ¬","func":"// æ“ä½œæˆåŠŸæ–‡æ¡ˆ,å¯å˜æ›´æˆå…¶ä»–è¯\nmsg.payload = `æ“ä½œå·²æˆåŠŸ`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":1170,"y":445,"wires":[["5b0381d.addc38"]]},{"id":"e70679a2.f179a8","type":"join","z":"50a9f5e.b33610c","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"0.1","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":985,"y":445,"wires":[["5f2f6570.b2435c","c502a43.7309958"]]},{"id":"5b0381d.addc38","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":1360,"y":445,"wires":[]},{"id":"47f8345a.030bcc","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§å¤„ç†æ•°æ®","func":"// POSTæ¥å£\n// æ”¯æŒä¸¤ä¸ªå‚æ•°\n// cmd: å¿…é€‰å‚æ•°,æ“ä½œæŒ‡ä»¤,ç±»ä¼¼\"æ‰“å¼€ä¹¦æˆ¿æ’åº§å’Œå°çˆ±å¼€å…³\"\n// tts: å¯é€‰å‚æ•°,ç”¨äºæ‰¾ä¸åˆ°è®¾å¤‡æ—¶çš„å†…å®¹è¿”å›\n\n\nconst cmd = msg.payload.cmd || ''\nconst tts = msg.payload.tts || ''\n\n// æœåŠ¡åˆ—è¡¨,ä¸€èˆ¬ä¸ç”¨åŠ¨äº†\nconst service_list = {\n  // å¼€å…³è¯ä¸åŠ¨ä½œæ˜ å°„,é…Œæƒ…ä¿®æ”¹\n  'act': {\n    'turn_on': ['æ‰“å¼€', 'å¼€å¼€', 'å¼€å¯'],\n    'turn_off': ['å…³é—­', 'å…³æ‰']\n  },\n  // ç‰¹æ®Šè®¾å¤‡çš„å¼€å…³åŠ¨ä½œæ˜ å°„\n  'alias': {\n    'cover': { 'turn_on': 'open_cover', 'turn_off': 'close_cover' },\n    'lock': { 'turn_on': 'unlock', 'turn_off': 'lock' }\n  }\n}\n\n//=== ä»¥ä¸‹å†…å®¹è°¨æ…ä¿®æ”¹ ===============================================================\n// è·å–HAè®¾å¤‡åˆ—è¡¨,ä»å¦å¤–ä¸€ä¸ªæµä¸­è·å–\nconst device_list = flow.get('device_list')\n// ç”Ÿæˆéœ€æ“ä½œçš„è®¾å¤‡åˆ—è¡¨\nconst list = device_list.filter(it => {\n  let service = ''\n  for (var key in service_list.act) {\n    if (!!service_list.act[key].filter(it => !!~cmd.indexOf(it)).length) {\n      service = key\n      break\n    }\n  }\n  if (!!~cmd.indexOf(it.friendly_name) && service !== '') {\n    return (it.service = service)\n  }\n}).map(it => {\n  it.data = { entity_id: it.entity_id }\n  return it\n})\nconst multi_list = list.map(it => {\n  return { res: msg.res, req: msg.req, payload: it, list, cmd, tts }\n})\nmulti_list.push({res:msg.res, req:msg.req, payload: {}, list, cmd, tts})\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()}`})\nreturn multi_list","outputs":4,"noerr":0,"x":280,"y":439,"wires":[["42c881da.6e936"],["42c881da.6e936"],["42c881da.6e936"],["42c881da.6e936"]]},{"id":"bb223237.e0386","type":"function","z":"50a9f5e.b33610c","name":"TTSæ–‡æœ¬","func":"msg.payload = `å˜¿å˜¿å˜¿,${msg.tts}`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":645,"y":392,"wires":[["eb0cef32.33fc1"]]},{"id":"eb0cef32.33fc1","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":805,"y":392,"wires":[]},{"id":"d26ee31d.2a5f8","type":"switch","z":"50a9f5e.b33610c","name":"","property":"payload.domain","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":635,"y":445,"wires":[["9878305e.8d142"]]},{"id":"42c881da.6e936","type":"switch","z":"50a9f5e.b33610c","name":"","property":"list.length","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"gt","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":455,"y":439,"wires":[["bb223237.e0386"],["d26ee31d.2a5f8"]]},{"id":"26af14fb.8dfa3c","type":"http request","z":"50a9f5e.b33610c","name":"","method":"POST","ret":"txt","url":"","tls":"","x":713,"y":590,"wires":[["d821983f.417f38"]]},{"id":"641a02ff.b945dc","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai","method":"post","upload":false,"swaggerDoc":"","x":103,"y":590,"wires":[["ebd83096.ac02a"]]},{"id":"ebd83096.ac02a","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§å¤„ç†æ•°æ®","func":"// POSTæ¥å£\n\n// å‚æ•°åˆ—è¡¨\n// cmd: è°ƒè¯•ç”¨çš„æ“ä½œè¯\n// asr: å°çˆ±ä¼ é€’ä¸Šæ¥çš„asrå†…å®¹\n// res: å°çˆ±ä¸“é€’ä¸Šæ¥çš„reså†…å®¹\n\nlet queries = []\nlet tts = ''\nmsg.payload.cmd && queries.push(msg.payload.cmd)\ntry { queries = JSON.parse(msg.payload.asr).response.queries.map(it => it.query) } catch (e) { }\n\ntry {\n  const res = JSON.parse(msg.payload.res);\n  tts = `${res.answer[0].content.to_speak}`\n} catch (e) {\n  tts = 'ä¸æ‡‚ä½ è¯´çš„å•¥'\n}\n\nconst list = [\n  // ç¬¬ä¸€ç§å†™æ³•,ç›´æ¥è½¬å‘ç»™HAè®¾å¤‡å¤„ç†\n  {\n    // æ“ä½œè¯æ•°ç»„,éœ€è¦é…ç½®å°çˆ±è„šæœ¬å®Œæˆæ‹¦æˆª\n    alias: ['æ—©å®‰', 'æ—©ä¸Šå¥½'],\n    // è½¬å‘ç»™NodeRedçš„haè®¾å¤‡æ“ä½œæ¥å£\n    proxy: '/miai/ha',\n    // haè®¾å¤‡æ“ä½œæ¥å£éœ€è¦çš„æŒ‡ä»¤è¯­å¥\n    cmd: 'æ‰“å¼€åŠŸç‡æ’åº§å’Œå°çˆ±å¼€å…³'\n  },\n  // ç¬¬äºŒç§å†™æ³•,è½¬å‘ç»™å¦å¤–ä¸€ä¸ªæ¥å£è¿›è¡Œå¤„ç†\n  {\n    alias: ['æ™šå®‰'],\n    proxy: '/miai/ha/goodnight'\n  },\n  // åŒç¬¬äºŒç§å†™æ³•,è¿™é‡Œæ¼”ç¤ºå¤šä¼ æ„Ÿå™¨ä¿¡æ¯åˆå¹¶æ’­æŠ¥\n  {\n    alias: ['å®¤å†…ç©ºæ°”è´¨é‡'],\n    proxy: '/miai/ha/airquality'\n  }\n]\n//=== ä»¥ä¸‹å†…å®¹è°¨æ…ä¿®æ”¹ ===============================================================\nmsg.queries = queries\nmsg.list = list\nmsg.tts = tts\nmsg.matched = !!list.filter((item, index) => {\n  item.matched = !!queries.filter(it => ~item.alias.indexOf(it)).length\n  if (item.matched) {\n    msg.matched_index = index\n    msg.matched_item = item\n  }\n  return item.matched\n}).length\n\nnode.status({ fill: 'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} åŒ¹é…: ${msg.matched}` })\n\nreturn msg","outputs":1,"noerr":0,"x":303,"y":590,"wires":[["5b58c1c9.b93e1"]]},{"id":"d821983f.417f38","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":893,"y":590,"wires":[]},{"id":"f0d4af65.3c523","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/ha/airquality","method":"post","upload":false,"swaggerDoc":"","x":138,"y":710,"wires":[["c39049c1.3e7be8","99ab23a6.9c33a","8a443463.36d3e8"]]},{"id":"f4892b75.2c53c8","type":"comment","z":"50a9f5e.b33610c","name":"å°çˆ±è½¬å‘ä¸»å…¥å£","info":"æ­¤æµç”¨æ¥æ¥æ”¶ä»å°çˆ±è½¬å‘è¿‡æ¥çš„asré‡Œçš„queryè¯\n\n\næ‰€æœ‰çš„ä¸€åˆ‡éƒ½æ˜¯ä»è¿™é‡Œå¼€å§‹çš„\n\næ€è·¯ï¼š\n\nå°çˆ±è®¾å¤‡è½¬å‘ä¸Šæ¥çš„asrå†…å®¹åœ¨è¿™ä¸ªæµé‡Œè¿›è¡ŒåŒ¹é…å’Œåˆ†å‘\n\nåŒ¹é…åˆ°åå¯ä»¥ç›´æ¥åˆ†å‘ç»™é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æµ,æ¯ä¸ªæµéƒ½æ˜¯ä¸€ä¸ªPOSTæ¥å£\n\nå¦‚æœæœªåŒ¹é…åˆ°åˆ™ç›´æ¥æŠŠå°çˆ±çš„asré‡Œçš„queryè¯å–ç¬¬ä¸€ä¸ªè½¬å‘ç»™HAçš„æ§åˆ¶æµ,è¯•å›¾ç›´æ¥ä½¿ç”¨æŒ‡ä»¤è¯å»æ§åˆ¶HAè®¾å¤‡çš„å¼€å…³\n\nå¦‚æœHAçš„æ§åˆ¶æµæ²¡æœ‰ä»»ä½•å¯å¤„ç†çš„è®¾å¤‡åˆ™è¿”å›å†…å®¹ç©º\n\n\nä¸¾ä¸ªä¾‹å­:\n\n```\nconst list = [\n  // ç¬¬ä¸€ç§å†™æ³•,ç›´æ¥è½¬å‘ç»™HAè®¾å¤‡å¤„ç†\n  {\n    // æ“ä½œè¯æ•°ç»„,éœ€è¦é…ç½®å°çˆ±è„šæœ¬å®Œæˆæ‹¦æˆª\n    alias: ['æ—©å®‰', 'æ—©ä¸Šå¥½'],\n    // è½¬å‘ç»™NodeRedçš„haè®¾å¤‡æ“ä½œæ¥å£\n    proxy: '/miai/ha',\n    // haè®¾å¤‡æ“ä½œæ¥å£éœ€è¦çš„æŒ‡ä»¤è¯­å¥\n    cmd: 'æ‰“å¼€åŠŸç‡æ’åº§å’Œå°çˆ±å¼€å…³'\n  },\n  // ç¬¬äºŒç§å†™æ³•,è½¬å‘ç»™å¦å¤–ä¸€ä¸ªæ¥å£è¿›è¡Œå¤„ç†\n  {\n    alias: ['æ™šå®‰'],\n    proxy: '/miai/ha/goodnight'\n  },\n  // åŒç¬¬äºŒç§å†™æ³•,è¿™é‡Œæ¼”ç¤ºå¤šä¼ æ„Ÿå™¨ä¿¡æ¯åˆå¹¶æ’­æŠ¥\n  {\n    alias: ['å®¤å†…ç©ºæ°”è´¨é‡'],\n    proxy: '/miai/ha/airquality'\n  }\n]\n```\n\nä¸Šä¸ªåˆ—è¡¨ä¸­ä¸€å…±æœ‰3ç»„è‡ªå®šä¹‰çš„æ“ä½œ\n\næ¯ç»„ä¸­æœ‰3ä¸ªå­—æ®µ,ä½œç”¨åˆ†åˆ«æ˜¯:\n\n\nalias\n```\nè¿™ä¸ªå­—æ®µæ˜¯ç”¨äºè·Ÿå°çˆ±çš„asré‡Œçš„queryæ•°ç»„é‡Œçš„è¯è¿›è¡ŒåŒ¹é…çš„\næ¯”å¦‚å°çˆ±çš„asrçš„queryè¯æ˜¯\"æ—©å®‰\"æˆ–è€…æ˜¯\"æ—©ä¸Šå¥½\",é‚£ä¹ˆåˆ™åŒ¹é…åˆ°ç¬¬ä¸€ç»„é…ç½®\n```\n\nproxy\n```\nè¿™ä¸ªå­—æ®µæ˜¯å±äºè½¬å‘çš„uriéƒ¨åˆ†,æˆ‘ä»¬é€šå¸¸æ˜¯è½¬å‘ç»™å½“å‰NodeRedçš„å…¶ä»–æ¥å£è¿›è¡Œå¤„ç†\næ¯”å¦‚/miai/ha\nè¿™ä¸ªå°±æ˜¯åœ¨NodeRedé‡Œå®šä¹‰æ¥æ”¶æ“ä½œHAè®¾å¤‡çš„æ¥å£URI,é»˜è®¤ä¸ºpost\n```\n\ncmd\n```\nè¿™ä¸ªæ˜¯é…åˆproxyå­—æ®µä½¿ç”¨çš„,ä¸»è¦ç”¨äºç»™/miai/haä¼ é€’å…·ä½“çš„æŒ‡ä»¤å†…å®¹\nç”±äº/miai/haæ¥å£çš„cmdæ¥æ”¶çš„æ˜¯ç±»ä¼¼äº\"æ‰“å¼€ä¹¦æˆ¿æ’åº§\"è¿™ç§æŒ‡ä»¤,æ‰€ä»¥cmdçš„å–å€¼åº”è¯¥ä¸ºå¯ä»¥æ­£å¸¸æ“ä½œHAè®¾å¤‡çš„æŒ‡ä»¤è¯\n```\n","x":123,"y":545,"wires":[]},{"id":"64e5bb32.f962d4","type":"comment","z":"50a9f5e.b33610c","name":"å®¤å†…ç©ºæ°”è´¨é‡","info":"","x":108,"y":665,"wires":[]},{"id":"c39049c1.3e7be8","type":"api-current-state","z":"50a9f5e.b33610c","name":"PM2.5","server":"4ccda836.aef688","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.m1_pm25","x":378,"y":710,"wires":[["2f5e60db.102cb"]]},{"id":"99ab23a6.9c33a","type":"api-current-state","z":"50a9f5e.b33610c","name":"æ¸©åº¦","server":"4ccda836.aef688","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.m1_temperature","x":378,"y":765,"wires":[["2f5e60db.102cb"]]},{"id":"2f5e60db.102cb","type":"join","z":"50a9f5e.b33610c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":623,"y":710,"wires":[["2891ec64.69a764"]]},{"id":"8a443463.36d3e8","type":"api-current-state","z":"50a9f5e.b33610c","name":"æ¹¿åº¦","server":"4ccda836.aef688","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.m1_humidity","x":378,"y":820,"wires":[["2f5e60db.102cb"]]},{"id":"2891ec64.69a764","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§TTSæ–‡æœ¬","func":"msg.payload = `\n    å½“å‰å®¤å†…PM2.5ä¸º${msg.payload['sensor.m1_pm25']}\n    æ¸©åº¦${msg.payload['sensor.m1_temperature']}æ‘„æ°åº¦\n    æ¹¿åº¦${msg.payload['sensor.m1_humidity']}%\n`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":788,"y":710,"wires":[["b61fc27d.9bcdf"]]},{"id":"b61fc27d.9bcdf","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":963,"y":710,"wires":[]},{"id":"b3029ea5.defb1","type":"debug","z":"50a9f5e.b33610c","name":"ä¸»è½¬å‘è°ƒè¯•","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":723,"y":543,"wires":[]},{"id":"c502a43.7309958","type":"debug","z":"50a9f5e.b33610c","name":"æ“ä½œHAè®¾å¤‡ç»“æœ","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1185,"y":397,"wires":[]},{"id":"834bab1e.218948","type":"api-call-service","z":"50a9f5e.b33610c","name":"å…³é—­æ‰€æœ‰FFU","server":"4ccda836.aef688","service_domain":"switch","service":"turn_off","data":"{\"entity_id\":\"switch.original_xiaomi_mi_smart_wifi_socket,switch.xiaomi_mi_smart_wifi_usb_socket\"}","mergecontext":"","x":388,"y":951,"wires":[["beefe6ab.f09348"]]},{"id":"52d8329a.1ff71c","type":"api-call-service","z":"50a9f5e.b33610c","name":"å…³é—­æ‰€æœ‰Airx","server":"4ccda836.aef688","service_domain":"fan","service":"turn_off","data":"{\"entity_id\":\"fan.airx,fan.airx2\"}","mergecontext":"","x":388,"y":1001,"wires":[["beefe6ab.f09348"]]},{"id":"beefe6ab.f09348","type":"join","z":"50a9f5e.b33610c","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":623,"y":950,"wires":[["e2e723fc.e4d69"]]},{"id":"e424ab63.80e548","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/ha/goodnight","method":"post","upload":false,"swaggerDoc":"","x":153,"y":950,"wires":[["834bab1e.218948","52d8329a.1ff71c"]]},{"id":"50c92150.e116b","type":"comment","z":"50a9f5e.b33610c","name":"æ™šå®‰","info":"","x":93,"y":905,"wires":[]},{"id":"e2e723fc.e4d69","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§TTSæ–‡æœ¬","func":"msg.payload = 'æ™šå®‰å§'\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":788,"y":950,"wires":[["99696025.ab7aa"]]},{"id":"99696025.ab7aa","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":958,"y":950,"wires":[]},{"id":"54db89a2.7737f8","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/get/res","method":"get","upload":false,"swaggerDoc":"","x":659,"y":85,"wires":[["7412ff3c.619ed"]]},{"id":"68249ad7.f7ee94","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":1005,"y":85,"wires":[]},{"id":"7412ff3c.619ed","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§æ‹¦æˆªè¯","func":"// å¤šä¸ªè¯ä»¥ç«–çº¿åˆ†å‰²\nmsg.payload = `soundboxControlTV`\nreturn msg","outputs":1,"noerr":0,"x":845,"y":85,"wires":[["68249ad7.f7ee94"]]},{"id":"4b4d3188.9ee63","type":"comment","z":"50a9f5e.b33610c","name":"å°çˆ±resæ‹¦æˆªè¯","info":"è¿™é‡Œä¸»è¦æ˜¯é…ç½®å°çˆ±è¿œç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”å†…å®¹çš„åŒ¹é…éƒ¨åˆ†\n\nå¤§å¤šæ•°æƒ…å†µä¸‹,åœ¨ä½ è¯´è¯æ§åˆ¶ä¸€ä¸ªä¸å­˜åœ¨çš„è®¾å¤‡çš„æ—¶å€™,å°çˆ±ä¼šè¿”å›ä¸€ä¸ªæ“ä½œè®¾å¤‡çš„æ ‡å¿—ä½,å·²åœ¨è„šæœ¬ä¸­è¿›è¡Œäº†ä¸»åŠ¨æ‹¦æˆª\n\nä½†æ˜¯æœ‰ä¸€äº›ä¾‹å¤–,æ¯”å¦‚æ“ä½œæ™ºèƒ½ç”µè§†\n\nå¦‚é‡åˆ°æœªæ•è·çš„æƒ…å†µ,å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œé…ç½®ç‰¹å®šè¯è¯­,ä¸æ¨èä½¿ç”¨\"æ²¡æœ‰\"è¿™ä¸ªè¯,å› ä¸ºæ®µå­å’Œæ­Œæ›²é‡Œéƒ½æœ‰å¯èƒ½å‡ºç°è¿™ä¸ªè¯","x":649,"y":40,"wires":[]},{"id":"e6e46051.21119","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/set/log","method":"post","upload":false,"swaggerDoc":"","x":1220,"y":85,"wires":[["cdbd2af.2d6acd8","20207240.9eee7e","2cea0054.4db4"]]},{"id":"2c5ab385.28453c","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":1556,"y":85,"wires":[]},{"id":"cdbd2af.2d6acd8","type":"function","z":"50a9f5e.b33610c","name":"è¿”å›å†…å®¹","func":"msg.payload = 'ok'\nreturn msg","outputs":1,"noerr":0,"x":1396,"y":85,"wires":[["2c5ab385.28453c"]]},{"id":"ea8a4e2d.83caf","type":"comment","z":"50a9f5e.b33610c","name":"å…¨é‡å°çˆ±çš„æ—¥å¿—","info":"åœ¨è¿™é‡Œæ¥å°çˆ±çš„å…¨é‡å˜æ›´çš„asrå’Œreså†…å®¹,ä¾¿äºå¿«é€Ÿçœ‹åˆ°å°çˆ±ä¸Šçš„æ—¥å¿—å†…å®¹\n\næ–¹ä¾¿å»ä¿®æ”¹å’Œå®šä¹‰asrå’Œresçš„æ‹¦æˆªè¯","x":1210,"y":40,"wires":[]},{"id":"4c622667.38df28","type":"http in","z":"50a9f5e.b33610c","name":"","url":"/miai/list","method":"get","upload":false,"swaggerDoc":"","x":825,"y":235,"wires":[["f02f7ee0.cd59c"]]},{"id":"f02f7ee0.cd59c","type":"function","z":"50a9f5e.b33610c","name":"HTML","func":"const device_list = flow.get('device_list')\nconst list = []\ndevice_list.map(it=>{\n  list.push(`<li>${it.domain} -> ${it.friendly_name}</li>`)\n})\n\nmsg.payload = `\n<!doctype html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<title>HAè®¾å¤‡åˆ—è¡¨</title>\n</head>\n<body>\n  <ol>\n    ${list.join('')}\n  </ul>\n</body>\n</html>\n`\nreturn msg","outputs":1,"noerr":0,"x":995,"y":235,"wires":[["705d6873.d42928"]]},{"id":"705d6873.d42928","type":"http response","z":"50a9f5e.b33610c","name":"","statusCode":"200","headers":{},"x":1150,"y":235,"wires":[]},{"id":"b26954b6.3e1ff8","type":"comment","z":"50a9f5e.b33610c","name":"æŸ¥çœ‹HAè®¾å¤‡åˆ—è¡¨","info":"ä¸€ä¸ªç®€å•ç½‘é¡µæŸ¥çœ‹HAè®¾å¤‡åˆ—è¡¨\n\nç›´æ¥æ‰“å¼€NodeRedçš„`http://NodeRed IP/miai/list`","x":835,"y":185,"wires":[]},{"id":"20207240.9eee7e","type":"function","z":"50a9f5e.b33610c","name":"è°ƒè¯•ä¿¡æ¯","func":"let queries = ''\ntry { queries = JSON.parse(msg.payload.asr).response.queries.map(it => it.query).join(',') } catch (e) { }\nlet domain = 'æœªçŸ¥'\ntry { domain = JSON.parse(msg.payload.res).answer[0].domain } catch (e) { }\nlet code = 'æœªçŸ¥'\ntry { code = JSON.parse(msg.payload.res).status.extend.code } catch (e) { }\nlet err = 'æœªçŸ¥'\ntry { err = JSON.parse(msg.payload.res).status.extend.name } catch (e) { }\nreturn {queries, domain, code, err}","outputs":1,"noerr":0,"x":1400,"y":135,"wires":[["80d62564.8a2be8"]]},{"id":"80d62564.8a2be8","type":"debug","z":"50a9f5e.b33610c","name":"è°ƒè¯•æ—¥å¿—","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1560,"y":135,"wires":[]},{"id":"2cea0054.4db4","type":"debug","z":"50a9f5e.b33610c","name":"å…¨é‡æ—¥å¿—","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1395,"y":40,"wires":[]},{"id":"5b58c1c9.b93e1","type":"function","z":"50a9f5e.b33610c","name":"ğŸ”§é…ç½®è½¬å‘","func":"// @fixme: å¯èƒ½ä¼šå­˜åœ¨hassioçš„nodredå¯†ç é—®é¢˜,éœ€è¦ç»“åˆå®é™…è¿›è¡Œè°ƒè¯•\n// å¦‚æœåœ¨å‰é¢çš„æµç¨‹é‡Œæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡åˆ™è½¬å‘ç»™å¯¹åº”æµç¨‹å¤„ç†\n\nconst tts = msg.tts\n\nif (msg.matched) {\n  // æ ¹æ®è‡ªå·±çš„NodeRedåœ°å€æƒ…å†µè¿›è¡Œä¿®æ”¹,å¦‚æœæœ‰å¯†ç å»åé¢çš„httpè¯·æ±‚é‡Œè®¾ç½®ä¸‹è´¦å·å¯†ç \n  msg.url = `http://127.0.0.1:1880${msg.matched_item.proxy}`\n  msg.payload = { cmd: msg.matched_item.cmd, tts }\n}\n// å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆ™è¯•å›¾è½¬å‘ç»™HAè‡ªåŠ¨åˆ¤æ–­\nelse {\n  // æ ¹æ®è‡ªå·±çš„NodeRedåœ°å€æƒ…å†µè¿›è¡Œä¿®æ”¹,å¦‚æœæœ‰å¯†ç å»åé¢çš„httpè¯·æ±‚é‡Œè®¾ç½®ä¸‹è´¦å·å¯†ç \n  msg.url = `http://127.0.0.1:1880/miai/ha`\n  msg.payload = { cmd: msg.queries[0], tts }\n}\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} åŒ¹é…: ${msg.matched} é¢„å¤‡TTS: ${tts}`})\nreturn msg","outputs":1,"noerr":0,"x":503,"y":590,"wires":[["b3029ea5.defb1","26af14fb.8dfa3c"]]},{"id":"4ccda836.aef688","type":"server","z":"","name":"HASS","legacy":false}]
```

## NodeRedæµ[Hassio]ï¼ˆç›´æ¥å¯¼å…¥ï¼‰
```json
[{"id":"7f4ff722.f627e8","type":"tab","label":"miai_interception_V3","disabled":false,"info":""},{"id":"ab0062b7.8d4d28","type":"debug","z":"7f4ff722.f627e8","name":"HA_device_list","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":620,"y":235,"wires":[]},{"id":"d66306d8.11e9","type":"api-render-template","z":"7f4ff722.f627e8","name":"éå†è®¾å¤‡","server":"e8ae8f26.e5ef7","template":"{% for state in states %}\n{{ state.domain }}||||{{ state.entity_id }}||||{{ state.attributes.friendly_name }}\n  \n{%- endfor %}","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":295,"y":235,"wires":[["57875e51.d2fc78"]]},{"id":"57875e51.d2fc78","type":"function","z":"7f4ff722.f627e8","name":"generate_device_list","func":"const device_list = msg.payload.split('\\n').map(it => {\n  const [domain, entity_id, friendly_name] = it.split('||||')\n  return { domain, entity_id, friendly_name }\n})\nconst list = device_list.map(it => `${it.domain}\\t${it.friendly_name}`).join('\\n')\nflow.set('device_list', device_list)\nnode.status({fill:'green', text: (new Date()).toLocaleTimeString()})\nreturn {device_list, list}","outputs":1,"noerr":0,"x":460,"y":180,"wires":[["ab0062b7.8d4d28"]]},{"id":"bfcdebd0.ce79f8","type":"inject","z":"7f4ff722.f627e8","name":"every_ten_minutes","topic":"","payload":"","payloadType":"date","repeat":"600","crontab":"","once":true,"onceDelay":"1","x":150,"y":300,"wires":[["d66306d8.11e9"]]},{"id":"92293308.55fe78","type":"api-call-service","z":"7f4ff722.f627e8","name":"call_service","server":"e8ae8f26.e5ef7","version":1,"service_domain":"","service":"","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":815,"y":445,"wires":[["1b24a716.31e231"]]},{"id":"ceed7e8.5831c8","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/get/asr","method":"get","upload":false,"swaggerDoc":"","x":125,"y":90,"wires":[["1111c8e.ecb14b7"]]},{"id":"1e4650.054029b1","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":455,"y":90,"wires":[]},{"id":"1111c8e.ecb14b7","type":"function","z":"7f4ff722.f627e8","name":"intercepting_key_words","func":"// å¤šä¸ªè¯ä»¥ç«–çº¿åˆ†å‰²\nmsg.payload = `å…³é—­|å°æˆ¿é—´`\nreturn msg","outputs":1,"noerr":0,"x":330,"y":40,"wires":[["1e4650.054029b1"]]},{"id":"d938cf0c.d53a4","type":"comment","z":"7f4ff722.f627e8","name":"asr_key_word","info":"è¿™é‡Œä¸»è¦æ˜¯é…ç½®ä½ å¯¹å°çˆ±è¯´çš„è¯çš„éƒ¨åˆ†\n\næ­£å¸¸æƒ…å†µä½ è·Ÿå°çˆ±è¯´\"æ—©å®‰\"æ˜¯ä¸ä¼šè½¬å‘ç»™NodeRedçš„\n\næ‰€ä»¥ä¸ºäº†èƒ½è¯´\"æ—©å®‰\"çš„æ—¶å€™èµ°ä½ çš„è‡ªå®šä¹‰çš„æµç¨‹,éœ€è¦é…ç½®ä¸‹ä½ å…ˆæ‹¦æˆªçš„è¯è¯­åˆ—è¡¨\n","x":115,"y":45,"wires":[]},{"id":"60416409.109e5c","type":"comment","z":"7f4ff722.f627e8","name":"caching_device_list","info":"è¿™ä¸ªæµé‡Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿå®šæ—¶éå†HAçš„è®¾å¤‡åˆ—è¡¨\n\nä¸ºäº†ç»™HAè®¾å¤‡è‡ªåŠ¨æ“ä½œçš„æµåšå‡†å¤‡å·¥ä½œ\n\né»˜è®¤æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡\n\nåœ¨ä¿å­˜æµå1ç§’ä¹Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡\n\nå¹³æ—¶æ— éœ€æ‰‹åŠ¨æ‰§è¡Œæ­¤æµ\n\nè°ƒè¯•åŠæ³•:\n\nå¯ä»¥æ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ‰§è¡ŒæŒ‰é’®,ç„¶åçœ‹è°ƒè¯•çª—å£,æ‰¾åˆ°HAè®¾å¤‡åˆ—è¡¨è°ƒè¯•é¡¹,å±•å¼€listæ¡ç›®,å¯çœ‹åˆ°å½“å‰HAçš„è®¾å¤‡åˆ—è¡¨","x":130,"y":190,"wires":[]},{"id":"31440a4.b946e76","type":"comment","z":"7f4ff722.f627e8","name":"HAè®¾å¤‡è‡ªåŠ¨åˆ¤å®šå¤„ç†é€»è¾‘","info":"æ­¤æµè§£å†³é€šè¿‡æ“ä½œè¯è¿›è¡Œæ§åˆ¶HAè®¾å¤‡åˆ—è¡¨é‡Œçš„è®¾å¤‡\n\nå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œç¼“å­˜HAåˆ—è¡¨æµå»çœ‹è°ƒè¯•ä¿¡æ¯é‡Œçš„è®¾å¤‡åˆ—è¡¨,ç„¶åè¯•å›¾å»å¼€å…³ä»–,æ”¯æŒåŒæ—¶æœ€å¤§æ§åˆ¶4ä¸ªè®¾å¤‡\n\nå¦‚æœè®¾å¤‡åˆ—è¡¨æ˜¯:\n\n```\nbinary_sensor\tå¤§é—¨çŠ¶æ€\nbinary_sensor\tæ¥¼æ¢¯äººä½“æ„Ÿåº”\nbinary_sensor\tæ¥¼ä¸Šå¼€å…³\nbinary_sensor\tå¤§é—¨é—¨é“ƒ\nfan\tæ¥¼ä¸Šå‡€åŒ–å™¨\nfan\tæ¥¼ä¸‹å‡€åŒ–å™¨\ngroup\tAirxç©ºæ°”å‡€åŒ–å™¨\ngroup\tall fans\ngroup\tall lights\ngroup\tall switches\ngroup\tall vacuum cleaners\ngroup\tåŒ—äº¬\ngroup\tå®¢å…ç©ºæ°”æ£€æµ‹ä»ª\ngroup\tå°ç±³\ninput_select\täº®åº¦\nlight\tå°å¤œç¯\nsensor\tä¸»å§æ¹¿åº¦\nsensor\tå…‰ç…§åº¦\nsensor\tç”²é†›\nsensor\tæ¹¿åº¦\nsensor\té¢—ç²’ç‰©\nsensor\tæ¸©åº¦\nsensor\tä¸»å§æ¸©åº¦\nsensor\tå½©äº‘å¤©æ°”\nswitch\tä¸»å§åŠ æ¹¿å™¨\nswitch\tå°çˆ±å¼€å…³\nswitch\tä¹¦æˆ¿æ’åº§\nswitch\tæ¥¼ä¸‹FFU\nswitch\tåŠŸç‡æ’åº§\nswitch\tæ¥¼ä¸ŠFFU\nswitch\tUSBæ’åº§\nvacuum\tæ¥¼ä¸Šæ‰«åœ°æœºå™¨äºº\n```\n\n\næˆ‘ä»¬å¯ä»¥è¿™æ ·å»æ§åˆ¶è®¾å¤‡:\n\n```\næ‰“å¼€æ¥¼ä¸Šæ‰«åœ°æœºå™¨äºº\næ‰“å¼€å°å¤œç¯å’Œä¸»å§åŠ æ¹¿å™¨\nå…³é—­ä¹¦æˆ¿æ’åº§\n```\n","x":150,"y":379,"wires":[]},{"id":"a7faea9d.ec38c","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/ha","method":"post","upload":false,"swaggerDoc":"","x":110,"y":439,"wires":[["9a7986b4.7387"]]},{"id":"336406ae.cb15f2","type":"function","z":"7f4ff722.f627e8","name":"TTSæ–‡æœ¬","func":"// æ“ä½œæˆåŠŸæ–‡æ¡ˆ,å¯å˜æ›´æˆå…¶ä»–è¯\nmsg.payload = `æ“ä½œå·²æˆåŠŸ`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":1170,"y":445,"wires":[["414a4c2b.277f1c"]]},{"id":"1b24a716.31e231","type":"join","z":"7f4ff722.f627e8","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"0.1","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":990,"y":440,"wires":[["336406ae.cb15f2","8f518d92.1a7db8"]]},{"id":"414a4c2b.277f1c","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":1360,"y":445,"wires":[]},{"id":"9a7986b4.7387","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§å¤„ç†æ•°æ®","func":"// POSTæ¥å£\n// æ”¯æŒä¸¤ä¸ªå‚æ•°\n// cmd: å¿…é€‰å‚æ•°,æ“ä½œæŒ‡ä»¤,ç±»ä¼¼\"æ‰“å¼€ä¹¦æˆ¿æ’åº§å’Œå°çˆ±å¼€å…³\"\n// tts: å¯é€‰å‚æ•°,ç”¨äºæ‰¾ä¸åˆ°è®¾å¤‡æ—¶çš„å†…å®¹è¿”å›\n\n\nconst cmd = msg.payload.cmd || ''\nconst tts = msg.payload.tts || ''\n\n// æœåŠ¡åˆ—è¡¨,ä¸€èˆ¬ä¸ç”¨åŠ¨äº†\nconst service_list = {\n  // å¼€å…³è¯ä¸åŠ¨ä½œæ˜ å°„,é…Œæƒ…ä¿®æ”¹\n  'act': {\n    'turn_on': ['æ‰“å¼€', 'å¼€å¼€', 'å¼€å¯'],\n    'turn_off': ['å…³é—­', 'å…³æ‰']\n  },\n  // ç‰¹æ®Šè®¾å¤‡çš„å¼€å…³åŠ¨ä½œæ˜ å°„\n  'alias': {\n    'cover': { 'turn_on': 'open_cover', 'turn_off': 'close_cover' },\n    'lock': { 'turn_on': 'unlock', 'turn_off': 'lock' }\n  }\n}\n\n//=== ä»¥ä¸‹å†…å®¹è°¨æ…ä¿®æ”¹ ===============================================================\n// è·å–HAè®¾å¤‡åˆ—è¡¨,ä»å¦å¤–ä¸€ä¸ªæµä¸­è·å–\nconst device_list = flow.get('device_list')\n// ç”Ÿæˆéœ€æ“ä½œçš„è®¾å¤‡åˆ—è¡¨\nconst list = device_list.filter(it => {\n  let service = ''\n  for (var key in service_list.act) {\n    if (!!service_list.act[key].filter(it => !!~cmd.indexOf(it)).length) {\n      service = key\n      break\n    }\n  }\n  if (!!~cmd.indexOf(it.friendly_name) && service !== '') {\n    return (it.service = service)\n  }\n}).map(it => {\n  it.data = { entity_id: it.entity_id }\n  return it\n})\nconst multi_list = list.map(it => {\n  return { res: msg.res, req: msg.req, payload: it, list, cmd, tts }\n})\nmulti_list.push({res:msg.res, req:msg.req, payload: {}, list, cmd, tts})\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()}`})\nreturn multi_list","outputs":4,"noerr":0,"x":310,"y":440,"wires":[["c7216e86.a511c8"],["c7216e86.a511c8"],["c7216e86.a511c8"],["c7216e86.a511c8"]]},{"id":"8333dcee.1b6f4","type":"function","z":"7f4ff722.f627e8","name":"TTSæ–‡æœ¬","func":"msg.payload = `é•¿åº¦ä¸º0,${msg.tts}`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":645,"y":392,"wires":[["82cd0173.04a21"]]},{"id":"82cd0173.04a21","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":805,"y":392,"wires":[]},{"id":"94d62336.bd12a","type":"switch","z":"7f4ff722.f627e8","name":"","property":"payload.domain","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":635,"y":445,"wires":[["92293308.55fe78","45545be1.497534"]]},{"id":"c7216e86.a511c8","type":"switch","z":"7f4ff722.f627e8","name":"","property":"list.length","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"gt","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":440,"wires":[["8333dcee.1b6f4"],["94d62336.bd12a","bc72657d.61877"]]},{"id":"a3ac761d.0e97b8","type":"http request","z":"7f4ff722.f627e8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"http://127.0.0.1:1880/endpoint/miai/ha","tls":"","persist":false,"proxy":"","authType":"basic","x":713,"y":590,"wires":[["24f09e2b.461002"]]},{"id":"a0710d35.1f4b78","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai","method":"post","upload":false,"swaggerDoc":"","x":103,"y":590,"wires":[["2b309363.a3e984"]]},{"id":"2b309363.a3e984","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§å¤„ç†æ•°æ®","func":"// POSTæ¥å£\n\n// å‚æ•°åˆ—è¡¨\n// cmd: è°ƒè¯•ç”¨çš„æ“ä½œè¯\n// asr: å°çˆ±ä¼ é€’ä¸Šæ¥çš„asrå†…å®¹\n// res: å°çˆ±ä¸“é€’ä¸Šæ¥çš„reså†…å®¹\n\nlet queries = []\nlet tts = ''\nmsg.payload.cmd && queries.push(msg.payload.cmd)\ntry { queries = JSON.parse(msg.payload.asr).response.queries.map(it => it.query) } catch (e) { }\n\ntry {\n  const res = JSON.parse(msg.payload.res);\n  tts = `${res.answer[0].content.to_speak}`\n} catch (e) {\n  tts = 'ä¸æ‡‚ä½ è¯´çš„å•¥'\n}\n\nconst list = [\n  // ç¬¬ä¸€ç§å†™æ³•,ç›´æ¥è½¬å‘ç»™HAè®¾å¤‡å¤„ç†\n  {\n    // æ“ä½œè¯æ•°ç»„,éœ€è¦é…ç½®å°çˆ±è„šæœ¬å®Œæˆæ‹¦æˆª\n    alias: ['æ—©å®‰', 'æ—©ä¸Šå¥½'],\n    // è½¬å‘ç»™NodeRedçš„haè®¾å¤‡æ“ä½œæ¥å£\n    proxy: '/endpoint/miai/ha',\n    // haè®¾å¤‡æ“ä½œæ¥å£éœ€è¦çš„æŒ‡ä»¤è¯­å¥\n    cmd: 'å…³é—­çª—å¸˜'\n  },\n  // ç¬¬äºŒç§å†™æ³•,è½¬å‘ç»™å¦å¤–ä¸€ä¸ªæ¥å£è¿›è¡Œå¤„ç†\n  {\n    alias: ['æ™šå®‰'],\n    proxy: '/miai/ha/goodnight'\n  },\n  // åŒç¬¬äºŒç§å†™æ³•,è¿™é‡Œæ¼”ç¤ºå¤šä¼ æ„Ÿå™¨ä¿¡æ¯åˆå¹¶æ’­æŠ¥\n  {\n    alias: ['å®¤å†…ç©ºæ°”è´¨é‡'],\n    proxy: '/miai/ha/airquality'\n  }\n]\n//=== ä»¥ä¸‹å†…å®¹è°¨æ…ä¿®æ”¹ ===============================================================\nmsg.queries = queries\nmsg.list = list\nmsg.tts = tts\nmsg.matched = !!list.filter((item, index) => {\n  item.matched = !!queries.filter(it => ~item.alias.indexOf(it)).length\n  if (item.matched) {\n    msg.matched_index = index\n    msg.matched_item = item\n  }\n  return item.matched\n}).length\n\nnode.status({ fill: 'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} åŒ¹é…: ${msg.matched}` })\n\nreturn msg","outputs":1,"noerr":0,"x":303,"y":590,"wires":[["170bfe48.23edf2","590cf568.bd39b4"]]},{"id":"24f09e2b.461002","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":893,"y":590,"wires":[]},{"id":"3684369f.c182a2","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/ha/airquality","method":"post","upload":false,"swaggerDoc":"","x":138,"y":710,"wires":[["c6c23d7c.4d5958","ebd12bf8.8c412","83de650b.c9c9c"]]},{"id":"66afe3ad.12520c","type":"comment","z":"7f4ff722.f627e8","name":"å°çˆ±è½¬å‘ä¸»å…¥å£","info":"æ­¤æµç”¨æ¥æ¥æ”¶ä»å°çˆ±è½¬å‘è¿‡æ¥çš„asré‡Œçš„queryè¯\n\n\næ‰€æœ‰çš„ä¸€åˆ‡éƒ½æ˜¯ä»è¿™é‡Œå¼€å§‹çš„\n\næ€è·¯ï¼š\n\nå°çˆ±è®¾å¤‡è½¬å‘ä¸Šæ¥çš„asrå†…å®¹åœ¨è¿™ä¸ªæµé‡Œè¿›è¡ŒåŒ¹é…å’Œåˆ†å‘\n\nåŒ¹é…åˆ°åå¯ä»¥ç›´æ¥åˆ†å‘ç»™é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æµ,æ¯ä¸ªæµéƒ½æ˜¯ä¸€ä¸ªPOSTæ¥å£\n\nå¦‚æœæœªåŒ¹é…åˆ°åˆ™ç›´æ¥æŠŠå°çˆ±çš„asré‡Œçš„queryè¯å–ç¬¬ä¸€ä¸ªè½¬å‘ç»™HAçš„æ§åˆ¶æµ,è¯•å›¾ç›´æ¥ä½¿ç”¨æŒ‡ä»¤è¯å»æ§åˆ¶HAè®¾å¤‡çš„å¼€å…³\n\nå¦‚æœHAçš„æ§åˆ¶æµæ²¡æœ‰ä»»ä½•å¯å¤„ç†çš„è®¾å¤‡åˆ™è¿”å›å†…å®¹ç©º\n\n\nä¸¾ä¸ªä¾‹å­:\n\n```\nconst list = [\n  // ç¬¬ä¸€ç§å†™æ³•,ç›´æ¥è½¬å‘ç»™HAè®¾å¤‡å¤„ç†\n  {\n    // æ“ä½œè¯æ•°ç»„,éœ€è¦é…ç½®å°çˆ±è„šæœ¬å®Œæˆæ‹¦æˆª\n    alias: ['æ—©å®‰', 'æ—©ä¸Šå¥½'],\n    // è½¬å‘ç»™NodeRedçš„haè®¾å¤‡æ“ä½œæ¥å£\n    proxy: '/miai/ha',\n    // haè®¾å¤‡æ“ä½œæ¥å£éœ€è¦çš„æŒ‡ä»¤è¯­å¥\n    cmd: 'æ‰“å¼€åŠŸç‡æ’åº§å’Œå°çˆ±å¼€å…³'\n  },\n  // ç¬¬äºŒç§å†™æ³•,è½¬å‘ç»™å¦å¤–ä¸€ä¸ªæ¥å£è¿›è¡Œå¤„ç†\n  {\n    alias: ['æ™šå®‰'],\n    proxy: '/miai/ha/goodnight'\n  },\n  // åŒç¬¬äºŒç§å†™æ³•,è¿™é‡Œæ¼”ç¤ºå¤šä¼ æ„Ÿå™¨ä¿¡æ¯åˆå¹¶æ’­æŠ¥\n  {\n    alias: ['å®¤å†…ç©ºæ°”è´¨é‡'],\n    proxy: '/miai/ha/airquality'\n  }\n]\n```\n\nä¸Šä¸ªåˆ—è¡¨ä¸­ä¸€å…±æœ‰3ç»„è‡ªå®šä¹‰çš„æ“ä½œ\n\næ¯ç»„ä¸­æœ‰3ä¸ªå­—æ®µ,ä½œç”¨åˆ†åˆ«æ˜¯:\n\n\nalias\n```\nè¿™ä¸ªå­—æ®µæ˜¯ç”¨äºè·Ÿå°çˆ±çš„asré‡Œçš„queryæ•°ç»„é‡Œçš„è¯è¿›è¡ŒåŒ¹é…çš„\næ¯”å¦‚å°çˆ±çš„asrçš„queryè¯æ˜¯\"æ—©å®‰\"æˆ–è€…æ˜¯\"æ—©ä¸Šå¥½\",é‚£ä¹ˆåˆ™åŒ¹é…åˆ°ç¬¬ä¸€ç»„é…ç½®\n```\n\nproxy\n```\nè¿™ä¸ªå­—æ®µæ˜¯å±äºè½¬å‘çš„uriéƒ¨åˆ†,æˆ‘ä»¬é€šå¸¸æ˜¯è½¬å‘ç»™å½“å‰NodeRedçš„å…¶ä»–æ¥å£è¿›è¡Œå¤„ç†\næ¯”å¦‚/miai/ha\nè¿™ä¸ªå°±æ˜¯åœ¨NodeRedé‡Œå®šä¹‰æ¥æ”¶æ“ä½œHAè®¾å¤‡çš„æ¥å£URI,é»˜è®¤ä¸ºpost\n```\n\ncmd\n```\nè¿™ä¸ªæ˜¯é…åˆproxyå­—æ®µä½¿ç”¨çš„,ä¸»è¦ç”¨äºç»™/miai/haä¼ é€’å…·ä½“çš„æŒ‡ä»¤å†…å®¹\nç”±äº/miai/haæ¥å£çš„cmdæ¥æ”¶çš„æ˜¯ç±»ä¼¼äº\"æ‰“å¼€ä¹¦æˆ¿æ’åº§\"è¿™ç§æŒ‡ä»¤,æ‰€ä»¥cmdçš„å–å€¼åº”è¯¥ä¸ºå¯ä»¥æ­£å¸¸æ“ä½œHAè®¾å¤‡çš„æŒ‡ä»¤è¯\n```\n","x":120,"y":540,"wires":[]},{"id":"191cb3.c591ab4d","type":"comment","z":"7f4ff722.f627e8","name":"å®¤å†…ç©ºæ°”è´¨é‡","info":"","x":108,"y":665,"wires":[]},{"id":"c6c23d7c.4d5958","type":"api-current-state","z":"7f4ff722.f627e8","name":"PM2.5","server":"e8ae8f26.e5ef7","version":"1","outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"sensor.m1_pm25","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":378,"y":710,"wires":[["a2f603e9.aacd3"]]},{"id":"ebd12bf8.8c412","type":"api-current-state","z":"7f4ff722.f627e8","name":"æ¸©åº¦","server":"e8ae8f26.e5ef7","version":"1","outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"sensor.m1_temperature","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":378,"y":765,"wires":[["a2f603e9.aacd3"]]},{"id":"a2f603e9.aacd3","type":"join","z":"7f4ff722.f627e8","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":623,"y":710,"wires":[["f2839150.a31bb"]]},{"id":"83de650b.c9c9c","type":"api-current-state","z":"7f4ff722.f627e8","name":"æ¹¿åº¦","server":"e8ae8f26.e5ef7","version":"1","outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"sensor.m1_humidity","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":378,"y":820,"wires":[["a2f603e9.aacd3"]]},{"id":"f2839150.a31bb","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§TTSæ–‡æœ¬","func":"msg.payload = `\n    å½“å‰å®¤å†…PM2.5ä¸º${msg.payload['sensor.m1_pm25']}\n    æ¸©åº¦${msg.payload['sensor.m1_temperature']}æ‘„æ°åº¦\n    æ¹¿åº¦${msg.payload['sensor.m1_humidity']}%\n`\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":788,"y":710,"wires":[["f3612c4c.05278"]]},{"id":"f3612c4c.05278","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":963,"y":710,"wires":[]},{"id":"590cf568.bd39b4","type":"debug","z":"7f4ff722.f627e8","name":"ä¸»è½¬å‘è°ƒè¯•","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":310,"y":520,"wires":[]},{"id":"8f518d92.1a7db8","type":"debug","z":"7f4ff722.f627e8","name":"æ“ä½œHAè®¾å¤‡ç»“æœ","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1185,"y":397,"wires":[]},{"id":"61124886.631a08","type":"api-call-service","z":"7f4ff722.f627e8","name":"å…³é—­æ‰€æœ‰FFU","server":"e8ae8f26.e5ef7","version":"1","service_domain":"switch","service":"turn_off","entityId":"switch.original_xiaomi_mi_smart_wifi_socket,switch.xiaomi_mi_smart_wifi_usb_socket","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":388,"y":951,"wires":[["17b657d3.47388"]]},{"id":"3d07928c.d6c0c6","type":"api-call-service","z":"7f4ff722.f627e8","name":"å…³é—­æ‰€æœ‰Airx","server":"e8ae8f26.e5ef7","version":"1","service_domain":"fan","service":"turn_off","entityId":"fan.airx,fan.airx2","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":388,"y":1001,"wires":[["17b657d3.47388"]]},{"id":"17b657d3.47388","type":"join","z":"7f4ff722.f627e8","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":623,"y":950,"wires":[["381d7f20.c96888"]]},{"id":"6409d113.9d1cc8","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/ha/goodnight","method":"post","upload":false,"swaggerDoc":"","x":153,"y":950,"wires":[["61124886.631a08","3d07928c.d6c0c6"]]},{"id":"63c1458b.1eda44","type":"comment","z":"7f4ff722.f627e8","name":"æ™šå®‰","info":"","x":93,"y":905,"wires":[]},{"id":"381d7f20.c96888","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§TTSæ–‡æœ¬","func":"msg.payload = 'æ™šå®‰å§'\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} TTS: ${msg.payload}`})\nreturn msg","outputs":1,"noerr":0,"x":788,"y":950,"wires":[["9d49d4a0.a2202"]]},{"id":"9d49d4a0.a2202","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":958,"y":950,"wires":[]},{"id":"173ee617.4ed5e2","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/get/res","method":"get","upload":false,"swaggerDoc":"","x":659,"y":85,"wires":[["60dea1b4.dec89"]]},{"id":"e6ffdf8c.fc3648","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":1005,"y":85,"wires":[]},{"id":"60dea1b4.dec89","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§æ‹¦æˆªè¯","func":"// å¤šä¸ªè¯ä»¥ç«–çº¿åˆ†å‰²\nmsg.payload = ``\nreturn msg","outputs":1,"noerr":0,"x":860,"y":40,"wires":[["e6ffdf8c.fc3648"]]},{"id":"b4121055.1d67d","type":"comment","z":"7f4ff722.f627e8","name":"res_key_words","info":"è¿™é‡Œä¸»è¦æ˜¯é…ç½®å°çˆ±è¿œç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”å†…å®¹çš„åŒ¹é…éƒ¨åˆ†\n\nå¤§å¤šæ•°æƒ…å†µä¸‹,åœ¨ä½ è¯´è¯æ§åˆ¶ä¸€ä¸ªä¸å­˜åœ¨çš„è®¾å¤‡çš„æ—¶å€™,å°çˆ±ä¼šè¿”å›ä¸€ä¸ªæ“ä½œè®¾å¤‡çš„æ ‡å¿—ä½,å·²åœ¨è„šæœ¬ä¸­è¿›è¡Œäº†ä¸»åŠ¨æ‹¦æˆª\n\nä½†æ˜¯æœ‰ä¸€äº›ä¾‹å¤–,æ¯”å¦‚æ“ä½œæ™ºèƒ½ç”µè§†\n\nå¦‚é‡åˆ°æœªæ•è·çš„æƒ…å†µ,å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œé…ç½®ç‰¹å®šè¯è¯­,ä¸æ¨èä½¿ç”¨\"æ²¡æœ‰\"è¿™ä¸ªè¯,å› ä¸ºæ®µå­å’Œæ­Œæ›²é‡Œéƒ½æœ‰å¯èƒ½å‡ºç°è¿™ä¸ªè¯","x":659,"y":40,"wires":[]},{"id":"1d394966.edaab7","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/set/log","method":"post","upload":false,"swaggerDoc":"","x":1120,"y":120,"wires":[["2a0d84bb.9be7e4","dee37a7.26dc688","349b154.927f36a"]]},{"id":"133a5975.268637","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":1556,"y":85,"wires":[]},{"id":"2a0d84bb.9be7e4","type":"function","z":"7f4ff722.f627e8","name":"è¿”å›å†…å®¹","func":"msg.payload = 'ok'\nreturn msg","outputs":1,"noerr":0,"x":1396,"y":85,"wires":[["133a5975.268637"]]},{"id":"d392274c.2579a","type":"comment","z":"7f4ff722.f627e8","name":"å…¨é‡å°çˆ±çš„æ—¥å¿—","info":"åœ¨è¿™é‡Œæ¥å°çˆ±çš„å…¨é‡å˜æ›´çš„asrå’Œreså†…å®¹,ä¾¿äºå¿«é€Ÿçœ‹åˆ°å°çˆ±ä¸Šçš„æ—¥å¿—å†…å®¹\n\næ–¹ä¾¿å»ä¿®æ”¹å’Œå®šä¹‰asrå’Œresçš„æ‹¦æˆªè¯","x":1210,"y":40,"wires":[]},{"id":"9bd778f.f9d5b88","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai/list","method":"get","upload":false,"swaggerDoc":"","x":825,"y":235,"wires":[["dcf1194d.0fb518"]]},{"id":"dcf1194d.0fb518","type":"function","z":"7f4ff722.f627e8","name":"HTML","func":"const device_list = flow.get('device_list')\nconst list = []\ndevice_list.map(it=>{\n  list.push(`<li>${it.domain} -> ${it.friendly_name}</li>`)\n})\n\nmsg.payload = `\n<!doctype html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<title>HAè®¾å¤‡åˆ—è¡¨</title>\n</head>\n<body>\n  <ol>\n    ${list.join('')}\n  </ul>\n</body>\n</html>\n`\nreturn msg","outputs":1,"noerr":0,"x":995,"y":235,"wires":[["dd6e52c.fe6eab"]]},{"id":"dd6e52c.fe6eab","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":1150,"y":235,"wires":[]},{"id":"86865aa5.e72458","type":"comment","z":"7f4ff722.f627e8","name":"æŸ¥çœ‹HAè®¾å¤‡åˆ—è¡¨","info":"ä¸€ä¸ªç®€å•ç½‘é¡µæŸ¥çœ‹HAè®¾å¤‡åˆ—è¡¨\n\nç›´æ¥æ‰“å¼€NodeRedçš„`http://NodeRed IP/miai/list`","x":835,"y":185,"wires":[]},{"id":"dee37a7.26dc688","type":"function","z":"7f4ff722.f627e8","name":"è°ƒè¯•ä¿¡æ¯","func":"let queries = ''\ntry { queries = JSON.parse(msg.payload.asr).response.queries.map(it => it.query).join(',') } catch (e) { }\nlet domain = 'æœªçŸ¥'\ntry { domain = JSON.parse(msg.payload.res).answer[0].domain } catch (e) { }\nlet code = 'æœªçŸ¥'\ntry { code = JSON.parse(msg.payload.res).status.extend.code } catch (e) { }\nlet err = 'æœªçŸ¥'\ntry { err = JSON.parse(msg.payload.res).status.extend.name } catch (e) { }\nreturn {queries, domain, code, err}","outputs":1,"noerr":0,"x":1400,"y":135,"wires":[["4b48b53a.b73b0c"]]},{"id":"4b48b53a.b73b0c","type":"debug","z":"7f4ff722.f627e8","name":"è°ƒè¯•æ—¥å¿—","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1560,"y":135,"wires":[]},{"id":"349b154.927f36a","type":"debug","z":"7f4ff722.f627e8","name":"å…¨é‡æ—¥å¿—","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1395,"y":40,"wires":[]},{"id":"170bfe48.23edf2","type":"function","z":"7f4ff722.f627e8","name":"ğŸ”§é…ç½®è½¬å‘","func":"// @fixme: å¯èƒ½ä¼šå­˜åœ¨hassioçš„nodredå¯†ç é—®é¢˜,éœ€è¦ç»“åˆå®é™…è¿›è¡Œè°ƒè¯•\n// å¦‚æœåœ¨å‰é¢çš„æµç¨‹é‡Œæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡åˆ™è½¬å‘ç»™å¯¹åº”æµç¨‹å¤„ç†\n\nconst tts = msg.tts\n\nif (msg.matched) {\n  // æ ¹æ®è‡ªå·±çš„NodeRedåœ°å€æƒ…å†µè¿›è¡Œä¿®æ”¹,å¦‚æœæœ‰å¯†ç å»åé¢çš„httpè¯·æ±‚é‡Œè®¾ç½®ä¸‹è´¦å·å¯†ç \n  msg.url = `http://127.0.0.1:1880${msg.matched_item.proxy}`\n  msg.payload = { cmd: msg.matched_item.cmd, tts }\n}\n// å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆ™è¯•å›¾è½¬å‘ç»™HAè‡ªåŠ¨åˆ¤æ–­\nelse {\n  // æ ¹æ®è‡ªå·±çš„NodeRedåœ°å€æƒ…å†µè¿›è¡Œä¿®æ”¹,å¦‚æœæœ‰å¯†ç å»åé¢çš„httpè¯·æ±‚é‡Œè®¾ç½®ä¸‹è´¦å·å¯†ç \n  msg.url = `http://127.0.0.1:1880/endpoint/miai/ha`\n  msg.payload = { cmd: msg.queries[0], tts }\n}\nnode.status({fill:'green', text: `æ›´æ–°:${(new Date()).toLocaleTimeString()} åŒ¹é…: ${msg.matched} é¢„å¤‡TTS: ${tts}`})\nreturn msg","outputs":1,"noerr":0,"x":503,"y":590,"wires":[["590cf568.bd39b4","a3ac761d.0e97b8"]]},{"id":"f3a4e9ff.f29c6","type":"inject","z":"7f4ff722.f627e8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":240,"wires":[["d66306d8.11e9"]]},{"id":"99f69901.81ea48","type":"http in","z":"7f4ff722.f627e8","name":"","url":"/miai","method":"get","upload":false,"swaggerDoc":"","x":1102,"y":590,"wires":[["ea5db01.b2fa25"]]},{"id":"904dc914.d40448","type":"http response","z":"7f4ff722.f627e8","name":"","statusCode":"200","headers":{},"x":1312,"y":550,"wires":[]},{"id":"ea5db01.b2fa25","type":"function","z":"7f4ff722.f627e8","name":"some_content","func":"// å¤šä¸ªè¯ä»¥ç«–çº¿åˆ†å‰²\nmsg.payload = `æ—©å®‰|æ™šå®‰`\nreturn msg","outputs":1,"noerr":0,"x":1300,"y":680,"wires":[["904dc914.d40448"]]},{"id":"45545be1.497534","type":"debug","z":"7f4ff722.f627e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":520,"wires":[]},{"id":"bc72657d.61877","type":"debug","z":"7f4ff722.f627e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":610,"y":520,"wires":[]},{"id":"5050d57c.58f8b4","type":"api-call-service","z":"7f4ff722.f627e8","name":"miai_say_ttl_content","server":"e8ae8f26.e5ef7","version":1,"service_domain":"hello_miai","service":"force_send","entityId":"","data":"{{ msg.payload.data }}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":900,"y":300,"wires":[[]]},{"id":"26045342.376984","type":"change","z":"7f4ff722.f627e8","name":"set_ttl_content","rules":[{"t":"set","p":"content","pt":"msg","to":"éå†è®¾å¤‡æˆåŠŸ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":300,"wires":[["10a58145.8b792f"]]},{"id":"10a58145.8b792f","type":"function","z":"7f4ff722.f627e8","name":"vol_to_data_template","func":"\nmsg.payload = {\n    data: {\n            \"message\": msg.content,\n            \"miai_num\":\"0\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":300,"wires":[["5050d57c.58f8b4"]]},{"id":"e8ae8f26.e5ef7","type":"server","z":"","name":"Home Assistant"}]
```